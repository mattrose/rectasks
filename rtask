#!/usr/bin/env bash
# vim: set ts=4 sw=4 et:

source $HOME/.local/lib/rtask-util

tasksdir=$(gettasksdir)
[[ -d $tasksdir ]] || mkdir -p $tasksdir 
pushd $tasksdir

[[ -z $1 ]] && action=list || action=$1
shift 1
### if the next argument matches a taskid...
if echo $1 | grep -q -E "^\d+(\.\d+)*$" ; then
       taskid=$1
       shift 1
fi
text="$*"

main() {
    case $action in 
        edit)
            edit $taskid
            ;;
        complete)
            finish $taskid
            ;;
        move)
            move $taskid $text
            ;;
        add)
            add "$text"
            ;;
        details)
            details $taskid
            ;;
        list)
            if [[ -v taskid ]] ; then 
                details $taskid 
            else
                list 
            fi
            ;;
        priority)
            list p
            ;;
        comment)
            comment "$text"
            ;;
        *)
            echo "no"
            exit 1
            ;;
    esac    
}

move() {
    mv $(taskpath $1) $(newtaskpath $2)
    echo $(taskpath $1)
    echo $(newtaskpath $2) 
}
details() {
    path=$(taskpath $taskid)
    if [[ -e $path/complete ]] ; then echo -n "DONE: " ; fi
    if [[ -e $path/task ]] ; then cat $path/task ; fi
    if [[ -d $path/comments ]] ; then cat $path/comments/* ; fi
}

list() {
    if [[ $1 = "p" ]] ; then 
        tasklist=$(for f in $(find . -name task) ; do td=$(dirname $f) ; if [[ -e $td/priority ]] ; then p=$(cat $td/priority) ; else p=0 ; fi ; echo "$p $f" ; done | sort -k1,1nr -k2,2n | cut -f 2- -d ' ')
    else
        tasklist=$(find . -name task | sort -n)
    fi
    for f in $tasklist ; do
        taskdir="$(dirname $f)"
        if [[ -e $taskdir/complete ]] ; then
            continue
        fi
        taskfile=$(taskid $f)
        comments=$(getcommentcount $f)
        echo -n "$taskfile: "
        if [[ $comments -ne 0 ]] ; then
            echo -n "($comments) "
        fi
	    cat $f
    done
}

add() {
    path=$(newtaskpath $taskid)
    mkdir -p $path
    [[ -z $text ]] && ${EDITOR:=vim} $path/task || echo "$text" > ${path}/task
}

comment() {
    path=$(newcommentpath $taskid)
    mkdir -p $(dirname $path)
    [[ -z $* ]] && ${EDITOR:=vim} $path || echo $* > $path
}

main
