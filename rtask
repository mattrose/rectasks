#!/usr/bin/env bash
# vim: set ts=4 sw=4 et:

if [[ -e $HOME/.local/lib/rtask-util ]] ; then
    source $HOME/.local/lib/rtask-util
else
    echo "Cannot find rtask-util, make sure it is in $HOME/.local/lib/rtask-util"
    echo "Have you run the `install` script"
fi

usage() {
    cat <<'EOF'

    USAGE: rtask <action> <taskid> <text>
    if not given any arguments, rtask prints out a list of tasks
    
    Available Actions
    
    * add: rtask add <taskid> <text>.
      * if taskid is not specified it opens a new task
      * If taskid is specified, it opens a sub-task  
      * If text is not specified, it opens an editor
    * list: rtask list <taskid>
      * if taskid is specified, it prints out all the 
        detailsx for that task
    * complete: rtask complete taskid
      * marks a task as complete and removes it from 
        the list view
    * edit: rtask edit taskid 
      * opens $EDITOR for that task
    * comment: rtask comment taskid
      * adds a comment to a task
    * priority: rtask priority <taskid> <value>  
      * sets the priority of a task to make it appear
        higher or lower in the list
      * default is 0, negative numbers are lower
        priority and positive numbers are higher
    * move: rtask move <taskid> <taskid>
      * move a subtask to a different parent task
EOF
exit 1   
}

tasksdir=$(gettasksdir)
[[ -d $tasksdir ]] || mkdir -p $tasksdir 
pushd $tasksdir > /dev/null 

[[ -z $1 ]] && action="list" || action=$1
shift 1
### if the next argument matches a taskid...
if echo $1 | grep -q -E "^\d+(\.\d+)*$" ; then
       taskid=$1
       shift 1
fi

if ! [[ $action = "add" || $action = "list" ]] ; then 
    if  ! [[ -v taskid ]]  ; then 
        usage
    fi
fi
exit 0

main() {
    case $action in 
        edit)
            edit 
            ;;
        complete) 
            finish 
            ;;
        move)
            move $taskid $text
            ;;
        add)
            text="$*"
            add "$text"
            ;;
        list) #
            if [[ -v taskid ]] ; then 
                details $taskid 
            else
                list 
            fi
            ;;
        priority) #
            setpriority $taskid $text 
            ;;
        comment) # 
            text="$*"
            comment "$text"
            ;;
        *)
            usage
            exit 1
            ;;
    esac    
}

finish() {
    touch $(taskpath $taskid)/complete
}

move() {
    mv $(taskpath $1) $(newtaskpath $2)
    echo $(taskpath $1)
    echo $(newtaskpath $2) 
}
details() {
    path=$(taskpath $taskid)
    if [[ -e $path/complete ]] ; then echo -n "DONE: " ; fi
    if [[ -e $path/task ]] ; then cat $path/task ; fi
    if [[ -d $path/comments ]] ; then cat $path/comments/* ; fi
    if [[ -e $path/priority ]] ; then echo -n "P " ; cat $path/priority ; fi
}

list() {
    tasklist=$(for f in $(find . -name task) ; do td=$(dirname $f) ; if [[ -e $td/priority ]] ; then p=$(cat $td/priority) ; else p=0 ; fi ; echo "$p $f" ; done | sort -k1,1nr -k2,2n | cut -f 2- -d ' ')
    # tasklist=$(find . -name task | sort -n)
    for f in $tasklist ; do
        taskdir="$(dirname $f)"
        if [[ -e $taskdir/complete ]] ; then
            continue
        fi
        taskfile=$(taskid $f)
        comments=$(getcommentcount $f)
        echo -n "$taskfile: "
        if [[ $comments -ne 0 ]] ; then
            echo -n "($comments) "
        fi
	    cat $f
    done
}

add() {
    path=$(newtaskpath $taskid)
    mkdir -p $path
    [[ -z $text ]] && ${EDITOR:=vim} $path/task || echo "$text" > ${path}/task
}

comment() {
    path=$(newcommentpath $taskid)
    mkdir -p $(dirname $path)
    [[ -z $* ]] && ${EDITOR:=vim} $path || echo $* > $path
}

edit() {
    ${EDITOR:=vim} $(taskpath $taskid)/task
}

setpriority() {
    path=$(taskpath $taskid)/priority
    echo $2 > $path
}


main
